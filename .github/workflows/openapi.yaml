name: Verify API

on:
  pull_request:

jobs:
  openapi:
    name: Generate OpenAPI specification
    runs-on: ubuntu-latest

    env:
      VELA_KEYCLOAK_CLIENT_ID: ''
      VELA_KEYCLOAK_CLIENT_SECRET: ''
      VELA_KEYCLOAK_URL: 'http://example.com/'
      VELA_PGMETA_CRYPTO_KEY: ''
      VELA_POSTGRES_URL: 'postgresql+asyncpg://user:password@host:1234/database'
      VELA_JWT_SECRET: ''
      VELA_CLOUDFLARE_ZONE_ID: ''
      VELA_CLOUDFLARE_BRANCH_REF_CNAME: ''
      VELA_CLOUDFLARE_API_TOKEN: ''
      VELA_CLOUDFLARE_DOMAIN_SUFFIX: ''

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'

    - name: Install modified vela
      run: pip install .

    - name: Generate modified OpenAPI specification
      run: python3 -c 'import json; from simplyblock.vela.api  import app; print(json.dumps(app.openapi()))' > new-openapi.json

    - name: Persist specification
      uses: actions/upload-artifact@v4
      with:
        name: openapi-schema
        path: openapi.json

    - name: Generate base OpenAPI specification
      run: |
        git fetch origin ${{ github.base_ref }}
        git switch ${{ github.base_ref }}
        pip install .
        python3 -c 'import json; from simplyblock.vela.api  import app; print(json.dumps(app.openapi()))' > old-openapi.json

    - name: Diff to current specification
      id: diff
      uses: josephburnett/jd@v2.1.2
      with:
        args: old-openapi.json new-openapi.json

    - name: Print the diff
      run: |
        echo '${{ steps.diff.outputs.output }}' > openapi.diff
        cat openapi.diff

    - name: Add, update, or remove PR comment
      uses: actions/github-script@v7
      if: ${{ !github.event.pull_request.draft }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');

          // Find existing comments from this workflow
          const comments = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          // Look for previous comment from this bot with our marker
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('## OpenAPI Schema Changes')
          );

          const hasChanges = fs.existsSync('openapi.diff') && fs.statSync('openapi.diff').size > 1;

          if (hasChanges) {
            // Read the diff file
            const diff = fs.readFileSync('openapi.diff', 'utf8');
            const commentBody = `## OpenAPI Schema Changes\n\nThis PR introduces changes to the API:\n\n\`\`\`\n${diff}\n\`\`\``;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
              console.log('Created new comment');
            }
          } else {
            // No changes - delete comment if it exists
            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
              console.log('Deleted comment - no API changes detected');
            } else {
              console.log('No comment to delete - no API changes detected');
            }
          }
