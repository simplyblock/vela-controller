# Vela Controller

This repository contains the control-plane services and deployment tooling for Vela. It provides a FastAPI-based
application that manages organizations, projects, and per-branch Vela stack running on Kubevirt VM. The DNS endpoints are setup using Cloudflare DNS records. 


## Prerequisites
- Python **3.13**
- Access to a Kubernetes cluster with [KubeVirt](https://kubevirt.io) enabled. Installation steps [here](./docs/kubevirt.md)
- Cloudflare API token/zone (optional) for DNS record provisioning in real deployments

## Local Development

### Quick start with Docker Compose
1. `docker compose -f containers/compose.yml up --build`
2. Browse the API through the HAProxy reverse proxy at `http://localhost:8000` (the app serves under `/vela`).
3. Keycloak admin UI runs on `http://localhost:8000/auth` (default credentials `admin` / `admin`).

The Compose file mounts your local kubeconfig at (~/.kube/config) so API endpoints that call the Kubernetes API can reach a cluster.

The API token can be generated by running the below command. And this token expires after 5 mins.
```sh
export TOKEN=$(curl -s http://localhost:8000/auth/realms/vela/protocol/openid-connect/token   -H "Content-Type: application/x-www-form-urlencoded"   -d "username=testuser"   -d "password=testpassword"    -d "grant_type=password"   -d "client_id=frontend" -d "client_secret=client-secret" | jq -r '.access_token')

echo $TOKEN
```

## Testing & Tooling
- `tox -e lint` – Ruff lint checks
- `tox -e format-check` – Formatting verification
- `tox -e type-check` – mypy static type analysis
