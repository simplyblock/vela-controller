
api:
  enabled: true
  address: 0.0.0.0:9001

sources:
  docker_host:
    type: docker_logs
    exclude_containers:
      - vela-vector

transforms:
  project_logs:
    type: remap
    inputs:
      - docker_host
    source: |-
      .branch_id = "${VELA_BRANCH?VELA_BRANCH is required}"
      .event_message = del(.message)
      .appname = del(.container_name)
      del(.container_created_at)
      del(.container_id)
      del(.source_type)
      del(.stream)
      del(.label)
      del(.image)
      del(.host)
      del(.stream)
  router:
    type: route
    inputs:
      - project_logs
    route:
      rest: '.appname == "vela-rest"'
      realtime: '.appname == "vela-realtime"'
      storage: '.appname == "vela-storage"'
      functions: '.appname == "vela-functions"'
      db: '.appname == "vela-db"'
  # PostgREST logs are structured so we separate timestamp from message using regex
  rest_logs:
    type: remap
    inputs:
      - router.rest
    source: |-
      parsed, err = parse_regex(.event_message, r'^(?P<time>.*): (?P<msg>.*)$')
      if err == null {
          .event_message = parsed.msg
          .timestamp = to_timestamp!(parsed.time)
          .metadata.host = .branch_id
      }
  # Realtime logs are structured so we parse the severity level using regex (ignore time because it has no date)
  realtime_logs:
    type: remap
    inputs:
      - router.realtime
    source: |-
      .metadata.branch_id = del(.branch_id)
      .metadata.external_id = .metadata.branch_id
      parsed, err = parse_regex(.event_message, r'^(?P<time>\d+:\d+:\d+\.\d+) \[(?P<level>\w+)\] (?P<msg>.*)$')
      if err == null {
          .event_message = parsed.msg
          .metadata.level = parsed.level
      }
  # Storage logs may contain json objects so we parse them for completeness
  storage_logs:
    type: remap
    inputs:
      - router.storage
    source: |-
      .metadata.branch_id = del(.branch_id)
      .metadata.tenantId = .metadata.branch_id
      parsed, err = parse_json(.event_message)
      if err == null {
          .event_message = parsed.msg
          .metadata.level = parsed.level
          .metadata.timestamp = parsed.time
          .metadata.context[0].host = parsed.hostname
          .metadata.context[0].pid = parsed.pid
      }
  # Postgres logs some messages to stderr which we map to warning severity level
  db_logs:
    type: remap
    inputs:
      - router.db
    source: |-
      .metadata.host = "db-default"
      .metadata.parsed.timestamp = .timestamp

      parsed, err = parse_regex(.event_message, r'.*(?P<level>INFO|NOTICE|WARNING|ERROR|LOG|FATAL|PANIC?):.*', numeric_groups: true)

      if err != null || parsed == null {
        .metadata.parsed.error_severity = "info"
      }
      if parsed != null {
       .metadata.parsed.error_severity = parsed.level
      }
      if .metadata.parsed.error_severity == "info" {
          .metadata.parsed.error_severity = "log"
      }
      .metadata.parsed.error_severity = upcase!(.metadata.parsed.error_severity)

sinks:
  loki:
    type: 'loki'
    inputs:
      - db_logs
      - studio_logs
      - controller_logs
    endpoint: 'http://loki.loki.svc.cluster.local:3100'
    labels:
      branch_id: '${VELA_BRANCH?VELA_BRANCH is required}'
      level: '{{ .metadata.parsed.error_severity }}'
      appname: '{{ .appname }}'
      status: '{{ .metadata.response.status_code }}'
      method: '{{ .metadata.request.method }}'
      path: '{{ .metadata.request.path }}'
    encoding:
      codec: json
