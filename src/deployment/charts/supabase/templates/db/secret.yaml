{{- if .Values.db.enabled -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "supabase.db.fullname" . }}-cloudinit-userdata
type: Opaque
stringData:  
  userdata: |
    #cloud-config
    hostname: supabase-db
    password: ubuntu
    chpasswd: { expire: false }
    write_files:
      - path: /usr/local/bin/resize-postgres-volume.sh
        owner: root:root
        permissions: '0755'
        content: |
          #!/bin/sh
          set -eu

          PG_DEVICE="/dev/vdb"
          STORAGE_DEVICE="/dev/vdc"

          RESIZE2FS_BIN=$(command -v resize2fs 2>/dev/null || true)
          if [ -z "${RESIZE2FS_BIN}" ]; then
            RESIZE2FS_BIN="/sbin/resize2fs"
          fi

          if [ ! -x "${RESIZE2FS_BIN}" ]; then
            echo "resize2fs binary not found" >&2
            exit 0
          fi

          "${RESIZE2FS_BIN}" "${PG_DEVICE}"
          "${RESIZE2FS_BIN}" "${STORAGE_DEVICE}"
      - path: /usr/local/bin/resize-postgres-volume-cron.sh
        owner: root:root
        permissions: '0755'
        content: |
          #!/bin/sh
          set -eu

          # run resize every 5 secs
          for run in $(seq 1 12); do
            /usr/local/bin/resize-postgres-volume.sh || true
            if [ "${run}" -lt 12 ]; then
              sleep 5
            fi
          done
      - path: /etc/crontabs/root
        owner: root:root
        permissions: '0644'
        content: |
          SHELL=/bin/sh
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          * * * * * /usr/local/bin/resize-postgres-volume-cron.sh >> /var/log/auto-resizefs.log 2>&1
    runcmd:
      - mkdir -p /mnt/postgres_data
      - echo "Setting up PostgreSQL data directory..."
      - PG_DATA_DISK=/dev/vdb
      - STORAGE_API_DISK=/dev/vdc
      - SECRETS=/dev/vdd
      - COMPOSE_CONFIG=/dev/vde
      - JWT_SECRETS=/dev/vdf
      - |
        if ! blkid $PG_DATA_DISK; then
          mkfs.ext4 $PG_DATA_DISK
        fi
      - mount $PG_DATA_DISK /mnt/postgres_data
      - mkdir -p /mnt/postgres_data/pgdata
      - chown -R 999:999 /mnt/postgres_data/pgdata
      - chmod 700 /mnt/postgres_data/pgdata

      - |
        if ! blkid $STORAGE_API_DISK; then
          mkfs.ext4 $STORAGE_API_DISK
        fi
      - mkdir -p /mnt/postgres_data/storage
      - chmod 777 /mnt/postgres_data/storage
      - mount $STORAGE_API_DISK /mnt/postgres_data/storage

      - mkdir -p /secrets && mount $SECRETS /secrets
      - mkdir -p /compose-config && mount $COMPOSE_CONFIG /compose-config
      - mkdir -p /jwt && mount $JWT_SECRETS /jwt

      - mkdir -p /supabase
      - cp /compose-config/docker-compose.yml /supabase/docker-compose.yml
      - cp /compose-config/vector.yml /supabase/vector.yml
      - cp /compose-config/pg_hba.conf /supabase/pg_hba.conf

      - DB_PASSWORD=$(cat /secrets/password)
      - PGBOUNCER_ADMIN_PASSWORD=$(cat /secrets/pgbouncer_admin_password)
      - DB_PASSWORD_ENC=$(cat /secrets/password_encoded)
      - PGMETA_CRYPTO_KEY=$(cat /secrets/pgmeta_crypto_key)
      - JWT_SECRET=$(cat /jwt/secret)
      - ANON_KEY=$(cat /jwt/anonKey)
      - SERVICE_KEY=$(cat /jwt/serviceKey)
      - |
        cat >/supabase/.env <<EOF
        POSTGRES_DB=postgres
        POSTGRES_PASSWORD=${DB_PASSWORD}
        PGBOUNCER_ADMIN_PASSWORD=${PGBOUNCER_ADMIN_PASSWORD}
        POSTGRES_PASSWORD_ENC=${DB_PASSWORD_ENC}
        SUPABASE_JWT_SECRET=${JWT_SECRET}
        SUPABASE_ANON_KEY=${ANON_KEY}
        SUPABASE_SERVICE_KEY=${SERVICE_KEY}
        PGMETA_CRYPTO_KEY=${PGMETA_CRYPTO_KEY}
        EOF
      - chmod 600 /supabase/.env
      - cd /supabase
      - podman compose up -d
      - podman ps -a
      - rc-update add crond default || true
      - rc-service crond restart || true
{{- end }}
