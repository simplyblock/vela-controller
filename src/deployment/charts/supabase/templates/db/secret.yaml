{{- if .Values.db.enabled -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "supabase.db.fullname" . }}-cloudinit-userdata
type: Opaque
stringData:  
  userdata: |
    #cloud-config
    hostname: supabase-db2
    password: ubuntu
    chpasswd: { expire: false }
    runcmd:
      - mkdir -p /mnt/postgres_data
      - echo "Setting up PostgreSQL data directory..."
      - |
        if ! blkid /dev/vdb; then
          mkfs -t ext4 /dev/vdb
        fi
      - mount /dev/vdb /mnt/postgres_data
      - mkdir -p /mnt/postgres_data/pgdata
      - chown -R 999:999 /mnt/postgres_data/pgdata
      - chmod 700 /mnt/postgres_data/pgdata

      - podman create --name temp-supabase supabase/postgres:15.1.0.147
      - podman cp temp-supabase:/docker-entrypoint-initdb.d /
      - podman rm temp-supabase

      - mkdir -p /custom-init-scripts && mount /dev/vdc /custom-init-scripts
      - mkdir -p /custom-migrations && mount /dev/vdd /custom-migrations
      - mkdir -p /secrets && mount /dev/vde /secrets

      - cp /custom-init-scripts/98-webhooks.sql /docker-entrypoint-initdb.d/init-scripts/
      - cp /custom-init-scripts/99-roles.sql /docker-entrypoint-initdb.d/init-scripts/
      - cp /custom-init-scripts/99-create-admin-user.sql /docker-entrypoint-initdb.d/init-scripts/

      - cp /custom-init-scripts/99-logs.sql /docker-entrypoint-initdb.d/migrations/
      - cp /custom-init-scripts/99-realtime.sql /docker-entrypoint-initdb.d/migrations/
      - ADMIN_DB=$(cat /secrets/admindb)
      - ADMIN_USER=$(cat /secrets/adminusername)
      - ADMIN_PASSWORD=$(cat /secrets/adminpassword)
      - DB_PASSWORD=$(cat /secrets/password)

      - |-
        podman run -d \
            -v /mnt/postgres_data/pgdata:/var/lib/postgresql/data \
            -v /docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d \
            -p 5432:5432 \
            -p 9999:9999 \
            -e JWT_SECRET=your_jwt_secret \
            -e ADMIN_USER=$ADMIN_USER \
            -e ADMIN_DB=$ADMIN_DB \
            -e POSTGRES_PASSWORD=$DB_PASSWORD \
            -e ADMIN_PASSWORD=$ADMIN_PASSWORD \
            -e JWT_EXP=3600 \
            --restart always \
            docker.io/supabase/postgres:15.1.0.147
      
      - podman ps -a
{{- end }}
