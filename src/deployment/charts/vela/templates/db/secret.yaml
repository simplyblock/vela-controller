{{- if .Values.db.enabled -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "vela.db.fullname" . }}-cloudinit-userdata
type: Opaque
stringData:  
  userdata: |
    #cloud-config
    hostname: vela-db
    password: ubuntu
    chpasswd: { expire: false }
    write_files:
      - path: /usr/local/bin/resize-postgres-volume.sh
        owner: root:root
        permissions: '0755'
        content: |
          #!/bin/sh
          set -eu

          PG_DEVICE="/dev/vdb"
          STORAGE_DEVICE="/dev/vdc"
          ENABLE_STORAGE='{{ ternary "1" "0" .Values.storage.enabled }}'

          RESIZE2FS_BIN=$(command -v resize2fs 2>/dev/null || true)
          if [ -z "${RESIZE2FS_BIN}" ]; then
            RESIZE2FS_BIN="/sbin/resize2fs"
          fi

          if [ ! -x "${RESIZE2FS_BIN}" ]; then
            echo "resize2fs binary not found" >&2
            exit 0
          fi

          "${RESIZE2FS_BIN}" "${PG_DEVICE}"
          if [ "${ENABLE_STORAGE}" = "1" ] && [ -b "${STORAGE_DEVICE}" ]; then
            "${RESIZE2FS_BIN}" "${STORAGE_DEVICE}"
          fi
      - path: /usr/local/bin/resize-postgres-volume-cron.sh
        owner: root:root
        permissions: '0755'
        content: |
          #!/bin/sh
          set -eu

          # run resize every 5 secs
          for run in $(seq 1 12); do
            /usr/local/bin/resize-postgres-volume.sh || true
            if [ "${run}" -lt 12 ]; then
              sleep 5
            fi
          done
      - path: /usr/local/bin/update-pgbouncer-config.sh
        owner: root:root
        permissions: '0750'
        content: |
          #!/bin/sh
          set -eu

          API_SERVER="https://kubernetes.default.svc"
          CONFIGMAP_NAME='{{ printf "%s-pgbouncer" (include "vela.db.fullname" .) }}'
          TOKEN_FILE="/apitoken/token"
          NAMESPACE_FILE="/pgbouncer/namespace"
          CA_FILE="/apitoken/ca.crt"
          TARGET_FILE="/vela/pgbouncer/pgbouncer.ini"

          if [ ! -s "${TOKEN_FILE}" ] || [ ! -s "${NAMESPACE_FILE}" ]; then
            exit 0
          fi

          if ! command -v curl >/dev/null 2>&1; then
            exit 0
          fi

          if ! command -v jq >/dev/null 2>&1; then
            exit 0
          fi

          TOKEN=$(cat "${TOKEN_FILE}")
          NAMESPACE=$(cat "${NAMESPACE_FILE}")

          if [ -z "${TOKEN}" ] || [ -z "${NAMESPACE}" ]; then
            exit 0
          fi

          TMP_FILE=$(mktemp /tmp/pgbouncer.ini.XXXXXX)
          trap 'rm -f "$TMP_FILE"' EXIT
          CURL_FLAGS="-sS --fail"
          if [ -s "${CA_FILE}" ]; then
            CURL_FLAGS="${CURL_FLAGS} --cacert ${CA_FILE}"
          else
            CURL_FLAGS="${CURL_FLAGS} -k"
          fi

          RESPONSE=$(curl ${CURL_FLAGS} \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/json" \
            "${API_SERVER}/api/v1/namespaces/${NAMESPACE}/configmaps/${CONFIGMAP_NAME}") || exit 0

          printf '%s\n' "${RESPONSE}" | jq -er '.data["pgbouncer.ini"]' > "${TMP_FILE}" || exit 0

          mv "${TMP_FILE}" "${TARGET_FILE}"
          chmod 644 "${TARGET_FILE}"
      - path: /etc/crontabs/root
        owner: root:root
        permissions: '0644'
        content: |
          SHELL=/bin/sh
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          * * * * * /usr/local/bin/resize-postgres-volume-cron.sh >> /var/log/auto-resizefs.log 2>&1
          * * * * * /usr/local/bin/update-pgbouncer-config.sh >> /var/log/pgbouncer-sync.log 2>&1
    runcmd:
      - mkdir -p /mnt/postgres_data
      - echo "Setting up PostgreSQL data directory..."
      - PG_DATA_DISK=/dev/vdb
      - ENABLE_STORAGE={{ ternary "1" "0" .Values.storage.enabled }}
      - SECRETS=/dev/vdc
      - COMPOSE_CONFIG=/dev/vdd
      - JWT_SECRETS=/dev/vde
      - K8S_TOKEN=/dev/vdf
      - PGBOUNCER=/dev/vdg
      - STORAGE_API_DISK=/dev/vdh
      - |
        if ! blkid "$PG_DATA_DISK"; then
          mkfs.ext4 "$PG_DATA_DISK"
        fi
      - mount "$PG_DATA_DISK" /mnt/postgres_data
      - mkdir -p /mnt/postgres_data/pgdata
      - chown -R 999:999 /mnt/postgres_data/pgdata
      - chmod 700 /mnt/postgres_data/pgdata
      - |
        if [ "${ENABLE_STORAGE}" = "1" ] && [ -b "$STORAGE_API_DISK" ]; then
          if ! blkid "$STORAGE_API_DISK"; then
            mkfs.ext4 "$STORAGE_API_DISK"
          fi
          mkdir -p /mnt/postgres_data/storage
          chmod 777 /mnt/postgres_data/storage
          mount "$STORAGE_API_DISK" /mnt/postgres_data/storage
        fi

      - mkdir -p /secrets && mount $SECRETS /secrets
      - mkdir -p /compose-config && mount $COMPOSE_CONFIG /compose-config
      - mkdir -p /jwt && mount $JWT_SECRETS /jwt
      - mkdir -p /apitoken && mount $K8S_TOKEN /apitoken
      - mkdir -p /pgbouncer && mount $PGBOUNCER /pgbouncer

      - mkdir -p /vela/pgbouncer
      - cp /compose-config/docker-compose.yml /vela/docker-compose.yml
      - cp /compose-config/vector.yml /vela/vector.yml
      - cp /compose-config/pg_hba.conf /vela/pg_hba.conf

      - cp /pgbouncer/pgbouncer.ini /vela/pgbouncer/pgbouncer.ini
      - cp /pgbouncer/users.txt /vela/pgbouncer/users.txt
      - touch /vela/pgbouncer/userlist.txt
      - chmod 644 /vela/pgbouncer/pgbouncer.ini /vela/pgbouncer/users.txt /vela/pgbouncer/userlist.txt || true
      - chmod 755 /vela/pgbouncer

      - DB_PASSWORD=$(cat /secrets/password)
      - PGBOUNCER_ADMIN_PASSWORD=$(cat /secrets/pgbouncer_admin_password)
      - PGMETA_CRYPTO_KEY=$(cat /secrets/pgmeta_crypto_key)
      - JWT_SECRET=$(cat /jwt/secret)
      - ANON_KEY=$(cat /jwt/anonKey)
      - SERVICE_KEY=$(cat /jwt/serviceKey)
      - |
        cat >/vela/.env <<EOF
        POSTGRES_DB=postgres
        POSTGRES_PASSWORD=${DB_PASSWORD}
        PGBOUNCER_ADMIN_PASSWORD=${PGBOUNCER_ADMIN_PASSWORD}
        VELA_JWT_SECRET=${JWT_SECRET}
        VELA_ANON_KEY=${ANON_KEY}
        VELA_SERVICE_KEY=${SERVICE_KEY}
        PGMETA_CRYPTO_KEY=${PGMETA_CRYPTO_KEY}
        EOF
      - chmod 600 /vela/.env
      - cat /pgbouncer/namespace > /vela/pgbouncer.namespace
      - cat /apitoken/token > /vela/apiserver.token
      - chmod 600 /vela/pgbouncer.namespace /vela/apiserver.token
      - cd /vela
      - podman compose up -d
      - podman ps -a
      - rc-update add crond default || true
      - rc-service crond restart || true
{{- end }}
